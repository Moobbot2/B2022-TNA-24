<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .form-check-input+.form-label {
            margin-bottom: 0;
            margin-left: 10px;
        }

        .form-check-input {
            margin-top: 0;
            width: 20px;
            height: 20px;
        }

        .border-custom-4 {
            border: 4px solid;
            border-radius: 15px;
        }
    </style>
</head>

<body class="bg-light" style="
      background: url('./bg-0.jpg') no-repeat center center/cover;
      width: 100vw;
      height: 100vh;
      min-width: 300px !important;
    ">
    <div class="position-fixed"><button type="button" class="btn btn-danger js-update-model">Cập nhật mô hình</button>
    </div>
    <div class="container h-100 d-flex justify-content-center align-items-center">
        <main>
            <div class="card text-dark border-custom-4" style="background-color: #c5f5ffb5">
                <div class="card-header position-relative">
                    <div class="logo-who position-absolute" style="width: 50px">
                        <img src="./who-logo-png.png" alt="" class="img-fluid" />
                    </div>
                    <h1 class="card-title text-center">
                        Biểu mẫu dự đoán Ung thư đại trực tràng
                    </h1>
                </div>
                <form action class="js_form_submit">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="đau bụng" />
                                        <label for="" class="form-label">Đau bụng</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom" value="nôn" />
                                        <label for="" class="form-label">Nôn</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="chán ăn" />
                                        <label for="" class="form-label">Chán ăn</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="táo bón" />
                                        <label for="" class="form-label">Táo bón</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="sút cân" />
                                        <label for="" class="form-label">Sút cân</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="tiêu chảy" />
                                        <label for="" class="form-label">Tiêu chảy</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="phân có máu" />
                                        <label for="" class="form-label">Phân có máu</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="da niêm mạc vàng" />
                                        <label for="" class="form-label">Da niêm mạc vàng</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom" value="da sạm" />
                                        <label for="" class="form-label">Da sạm</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="hạch ngoại biên" />
                                        <label for="" class="form-label">Hạch ngoại biên</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="hạch thượng đòn" />
                                        <label for="" class="form-label">Hạch thượng đòn</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="bụng chướng" />
                                        <label for="" class="form-label">Bụng chướng</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="phản ứng thành bụng" />
                                        <label for="" class="form-label">Phản ứng thành bụng</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="cảm ứng phúc mạc" />
                                        <label for="" class="form-label">Cảm ứng phúc mạc</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="dấu hiệu rắn bò" />
                                        <label for="" class="form-label">Dấu hiệu rắn bò</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="quai ruột nổi" />
                                        <label for="" class="form-label">Quai ruột nổi</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="sờ thấy khối u" />
                                        <label for="" class="form-label">Sờ thấy khối u</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="thăm trực tràng có khối u" />
                                        <label for="" class="form-label">Thăm trực tràng có khối u</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="tiền sử ung thư" />
                                        <label for="" class="form-label">Tiền sử ung thư</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="chụp CT ổ bụng có khối u" />
                                        <label for="" class="form-label">Chụp CT ổ bụng có khối u</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-sm-6">
                                <div class="form-group">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input" name="symptom"
                                            value="nội soi đại tràng có khối u" />
                                        <label for="" class="form-label">Nội soi đại tràng có khối u</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-center">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="file-chamsoc" class="form-label h3">Phiếu chăm sóc/Kế hoạch chăm
                                        sóc</label>
                                    <input type="file" class="form-control js-file" id="file-chamsoc" name="cham_soc"
                                        accept=".pdf">
                                    <small class="form-text text-muted">Chỉ hỗ trợ định dạng PDF. Vui lòng tải lên file
                                        Phiếu chăm sóc hợp lệ.</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="file-dieutri" class="form-label h3">Tờ điều trị</label>
                                    <input type="file" class="form-control js-file" id="file-dieutri" name="dieu_tri"
                                        accept=".pdf">
                                    <small class="form-text text-muted">Chỉ hỗ trợ định dạng PDF. Vui lòng tải lên file
                                        Tờ điều trị hợp lệ.</small>
                                </div>
                            </div>
                        </div>
                        <div class="js-wrap">
                            <input type="hidden" name="ket_qua" value="0">
                            <button type="submit" class="btn btn-success">Dự đoán</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="card text-dark border-custom-4 mt-4" style="width: 100%; background-color: #89ffc8">
                <div class="card-header">
                    <h5 class="card-title">Kết quả dự đoán</h5>
                </div>
                <div class="card-body" style="height: 80px">
                    <h3 class="card-text js_check_crc text-center"></h3>
                </div>
            </div>
        </main>
    </div>
</body>
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Constants
    const API_URL = "http://192.168.33.104:5000";
    var btn_udpate_data = '<button type="button" class="btn btn-warning js-update-data">Trường hợp đặc trưng</button>';

    // Utility functions
    function validateSymptoms(symptoms) {
        if (!Array.isArray(symptoms) || symptoms.length === 0) {
            alert("Hãy chọn ít nhất một triệu chứng.");
            return false;
        }
        return true;
    }

    function handleApiError(xhr) {
        console.error("API Error:", xhr.responseJSON?.error || xhr.statusText);
        alert("Đã xảy ra lỗi. Vui lòng thử lại sau.");
    }

    function showStatus(message, isSuccess = true) {
        const statusElement = $(".js_check_crc");
        statusElement.text(message);
        statusElement.css("color", isSuccess ? "green" : "red");
    }

    // AJAX functions
    function predict(data) {
        $.ajax({
            type: "POST",
            url: `${API_URL}/api_predict`,
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(data),
            success: function (response) {
                // Display the predicted result
                $(".js_check_crc").text(response.predictions);
                $(".js-wrap").append(btn_udpate_data);
            },
            error: handleApiError,
        });
    }

    function insert_db(data) {
        if (confirm('Các triệu chứng này là trường hợp đặc trưng?')) {
            $.ajax({
                type: "POST",
                url: `${API_URL}/api_save_data`,
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(data),
                success: function (response) {
                    $(".js_check_crc").text(response.predictions);
                    if (response.error) console.log(response.error);

                },
                error: handleApiError,
            });
        } else {
            console.log('User canceled the operation.');
        }
    }

    function updateModel() {
        if (confirm('Cập nhật model?')) {
            $.ajax({
                type: "POST",
                url: `${API_URL}/api_update_module`,
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    showStatus(response.message);
                    alert(response.message);
                },
                error: handleApiError,
            });
        } else {
            console.log('Người dùng đã hủy thao tác.');
        }
    }

    $(document).off("click", ".js-update-model").on("click", ".js-update-model", function (e) {
        e.preventDefault();
        updateModel();
    });

    // Mã JavaScript để bật các ô checkbox dựa trên danh sách triệu chứng (symptoms)
    function activateCheckboxes(symptoms) {
        symptoms.forEach(function (symptom) {
            // Lấy tất cả các ô checkbox có giá trị giống với symptom và thuộc tính name là "symptom"
            const checkboxes = document.querySelectorAll(`input[value="${symptom}"][name="symptom"]`);
            checkboxes.forEach(checkbox => checkbox.checked = true);
        });
    }

    function handleFileUpload(event) {
        $('.js-file').not(this).val('');
        $('input[type="checkbox"]').prop('checked', false);

        const file = $(this).prop('files')[0];
        const nameFile = $(this).prop('name');
        const formData = new FormData();

        formData.append('file_pdf', file);
        formData.append('file_name', nameFile);

        showStatus("Đang xử lý file vui lòng chờ trong giây lát...");
        $(".js-update-data").remove();

        $.ajax({
            type: "POST",
            url: `${API_URL}/api_medical_record`,
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {
                console.log("symptoms:", response.symptoms);
                activateCheckboxes(response.symptoms);
                showStatus("Trích xuất thành công!", true);
                setTimeout(() => showStatus(""), 2000);
            },
            error: function(xhr) {
                handleApiError(xhr);
                $('input.js-file').val('');
            },
        });
    }

    function insertData(data) {
        var selectedSymptoms = [];
        $('input[name="symptom"]:checked').each(function () {
            selectedSymptoms.push($(this).val());
        });
        // Check if at least one symptom is selected
        if (selectedSymptoms.length === 0) {
            alert("Please select at least one symptom.");
            return;
        }
        selectedSymptoms.push($('input[name="ket_qua"]').val());

        // Log the selected symptoms to the console
        console.log(selectedSymptoms);
        console.log("Call insert_db");
        // Make a prediction request
        insert_db(data);
        $(".js-update-data").remove();
    };

    $(".js-file").change(function () {
        handleFileUpload.call(this);
    });

    // Event listeners
    $(document).ready(function () {
        $('input[name="symptom"]').change(function () {
            $(".js_check_crc").text("");
            $(".js-update-data").remove();
        });

        $('.js_form_submit').submit(function (e) {
            e.preventDefault();
            const selectedSymptoms = $('input[name="symptom"]:checked').map(function () {
                return $(this).val();
            }).get();

            if (!validateSymptoms(selectedSymptoms)) return;
            $(".js-update-data").remove();
            predict({ features: selectedSymptoms });
        });

        $(document).on("click", ".js-update-data", function () {
            const selectedSymptoms = $('input[name="symptom"]:checked').map(function () {
                return $(this).val();
            }).get();

            if (!validateSymptoms(selectedSymptoms)) return;
            console.log("selectedSymptoms: ", selectedSymptoms);
            selectedSymptoms.push($('input[name="ket_qua"]').val());
            insertData({ features: selectedSymptoms });
            $(".js-update-data").remove();
        });

        //$(".js-update-model").click(updateModel);
        $(".js-file").change(handleFileUpload);
    });


</script>

</html>